{% extends "layout.html" %}
{% block body %}

    <p id="auth">User {{ user_id }} - <a href="/" id="sync-now">Sync Now</a> - <a href="{{ url_for('dropbox_unlink') }}" method="post">Unlink from Dropbox and Log Out</a></p>

    <p id="status"></p>

    <form id="tag-filter" action="" method="get">
        <input type="text" id="query" name="query" value="" /> 
        <input type="submit" value="Go" />
    </form>

    <p id="paging"></p>

    <script type="text/javascript">

        var Picklr = {
            // Global variables for this app
            globals: {
                page: {{ page }},
                tags: [],
                syncing: false
            },
            // Cached UI elements
            ui: {
                idInput: null,
                descriptionInput: null,
                tagInput: null,
                queryInput: null,
                metaDataForm: null,
                filterForm: null,
                status: null,
                thumbs: null,
                paging: null,
                syncNow: null
            },
            // Cached templates
            template: {
                thumb: null,
                status: null,
                paging: null,
                viewer: null
            },
            // Display an informational status
            showInfo: function(msg) {
                Picklr.ui.status.html('<span class="info">INFO: ' + msg + '</span>');
            },
            // Display an error status
            showError: function(msg) {
                Picklr.ui.status.html('<span class="error">ERROR: ' + msg + '</span>');
            },
            // Load a page of files
            load: function(page, query, callback) {

                $.ajax({
                    url: '/load/' + page + (($.trim(query) === '') ? '' : '?query=' + query),
                    cache: false,
                    dataType: 'json'
                }).done(function(data) {
                    // Refresh the tag array *without reassigning the array*, 
                    // otherwise tagit autocomplete stops working...
                    Picklr.globals.tags.length = 0;
                    [].push.apply(Picklr.globals.tags, data.tags.split('|'));
                    // Buffer array to efficiently concatenate output HTML
                    var output = [];
                    // Create the thumbnail display
                    $.each(data.files, function(i, item) {
                        output.push(Picklr.template.thumb(item));
                    });
                    Picklr.ui.thumbs.html(output.join(''));
                    // Empty the output array
                    output.length = 0;
                    // Create the paging nav
                    for(var i = 1; i <= data.total_pages; i ++) 
                        output.push(Picklr.template.paging({ "n": i }));
                    Picklr.ui.paging.html(Picklr.template.status(data) + ' &nbsp; ' + output.join('|'));
                    // Populate the status bar
                    Picklr.showInfo('Ready.');
                    // If a callback function has been passed in, call it
                    if(typeof callback === 'function')
                        callback();
                }).fail(function(request, status, error) {
                    Picklr.showError(error);
                });

            },
            // Synchronise with Dropbox
            sync: function() {

                Picklr.ui.syncNow.html('Syncing...');
                Picklr.showInfo('Sync in progress...');
                Picklr.globals.syncing = true;
                
                $.ajax({
                    url: '/sync',
                    cache: false,
                    dataType: 'json'
                }).done(function(data) {
                    if(data.added != 0 || data.deleted != 0)
                        Picklr.showInfo(data.added + ' files added, ' + data.deleted + ' deleted. <a href="/" id="reload">Click here to reload</a>.');
                    else
                        Picklr.showInfo('Nothing changed.');
                }).fail(function(request, status, error) {
                    Picklr.showError(error);
                }).always(function() {
                    Picklr.ui.syncNow.html('Sync Now');
                    Picklr.globals.syncing = false;
                });

            },
            // Save metadata for an image
            save: function(page) {

                $.ajax({
                    url: '/save',
                    data: Picklr.ui.metaDataForm.serialize(),
                    cache: false,
                    type: 'POST',
                    dataType: 'json',
                }).done(function(data) {
                    // Push any new tags which were returned onto the global tag array
                    [].push.apply(Picklr.globals.tags, data.newtags);
                    // Update the data atributes of the edited item
                    var item = $('#i-' + Picklr.ui.idInput.val()).find('a.edit-tags').first();
                    item.data('tags', Picklr.ui.tagInput.val());
                    item.data('description', Picklr.ui.descriptionInput.val());
                    Picklr.showInfo('Saved.');
                }).fail(function(request, status, error) {
                    Picklr.showError(error);
                });

            },
            // Initialise the app on load
            init: function() {

                // Cache selectors for UI elements
                Picklr.ui.idInput = $('#fileid');
                Picklr.ui.descriptionInput = $('#description');
                Picklr.ui.tagInput = $('#tags');
                Picklr.ui.queryInput = $('#query');
                Picklr.ui.metaDataForm = $('#tag-editor');
                Picklr.ui.filterForm = $('#tag-filter');
                Picklr.ui.status = $('#status');
                Picklr.ui.thumbs = $('#thumbs');
                Picklr.ui.paging = $('#paging');
                Picklr.ui.syncNow = $('#sync-now');

                // Compile templates
                Picklr.template.thumb = Handlebars.compile($('#thumb-template').html());
                Picklr.template.status = Handlebars.compile($('#status-template').html());
                Picklr.template.paging = Handlebars.compile($('#paging-template').html());
                Picklr.template.viewer = Handlebars.compile($('#viewer-template').html());

                // Set up tag autocomplete on the tag edit field
                Picklr.ui.tagInput.tagit({
                    singleFieldDelimiter: '|',
                    autocomplete: {
                        delay: 0, 
                        minLength: 2,
                        source: Picklr.globals.tags
                    }
                });

                // Set up tag autocomplete on the tag query field
                Picklr.ui.queryInput.tagit({
                    singleFieldDelimiter: '|',
                    autocomplete: {
                        delay: 0, 
                        minLength: 2,
                        source: Picklr.globals.tags
                    }
                });

                // Handle tag edit button click
                Picklr.ui.thumbs.on('click', 'a.edit-tags', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var link = $(this);
                    Picklr.ui.thumbs.find('div').removeClass('selected');
                    link.parent().addClass('selected');
                    Picklr.ui.idInput.val(link.data('fileid'));
                    Picklr.ui.descriptionInput.val(link.data('description'))
                    Picklr.ui.tagInput.tagit('removeAll');
                    $.each(link.data('tags').split('|'), function(i, item) {
                        Picklr.ui.tagInput.tagit('createTag', item);
                    });
                    Picklr.ui.metaDataForm.show();
                    Picklr.ui.metaDataForm.find('.tagit input[type=text]:first').focus();
                });

                // Handle thumbnail click (view large version)
                Picklr.ui.thumbs.on('click', 'a.view-large', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var link = $(this);
                    var href = link.attr('href');

                    // If the browser doesn't support pushState, 
                    // just redirect user to the page URL
                    if (typeof history.pushState === 'undefined') 
                        location.href = href;

                    // Update the URL
                    history.pushState(null, null, href);

                    var html = Picklr.template.viewer({ 
                        'sharekey': link.data('sharekey'),
                        'path': link.data('path')
                    });

                    Picklr.ui.thumbs.after(html);
                });

                // Handle click on a page number link
                Picklr.ui.paging.on('click', 'a', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    var page = $(this).data('page');
                    var newUrl = '/' + page;

                    // If the browser doesn't support pushState, 
                    // just redirect user to the page URL
                    if (typeof history.pushState === 'undefined') 
                        location.href = newUrl;

                    // Set the global page variable and update the URL
                    Picklr.globals.page = page;
                    history.pushState(null, null, newUrl);
                    
                    Picklr.load(Picklr.globals.page, Picklr.ui.queryInput.val());
                });

                // Handle sync button click
                Picklr.ui.syncNow.on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    Picklr.sync();
                });

                // Handle reload link click
                Picklr.ui.status.on('click', '#reload', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    Picklr.load(Picklr.globals.page, Picklr.ui.queryInput.val());
                });

                // Handle edit form submit
                Picklr.ui.metaDataForm.on('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    Picklr.ui.metaDataForm.hide();
                    Picklr.ui.thumbs.find('div').removeClass('selected');
                    Picklr.save();
                });

                // Handle filter form submit
                Picklr.ui.filterForm.on('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    Picklr.ui.metaDataForm.hide();
                    Picklr.ui.thumbs.find('div').removeClass('selected');
                    Picklr.globals.page = 1;
                    Picklr.load(Picklr.globals.page, Picklr.ui.queryInput.val());
                });

                // Handle cancel button click
                $('#cancel-edit').on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    Picklr.ui.metaDataForm.hide();
                    Picklr.ui.thumbs.find('div').removeClass('selected');
                });

                // Handle user closing the window/tab
                $(window).bind('beforeunload', function () {
                    // Try to stop the user leaving in the middle of a sync operation
                    if (Picklr.globals.syncing) {
                        return 'A sync is currently in progress.';
                    }
                });

                // Handle back button actions
                $(window).bind('popstate', function(e) { 
                    // Remove the image viewer container when back is pressed
                    // TODO: Check url, no need to remove on every back button press
                    if(e.originalEvent.state === null)
                        $('#large-image-container').remove();
                });

                // Initially load the first page and kick off a sync operation
                Picklr.load(Picklr.globals.page, Picklr.ui.queryInput.val(), Picklr.sync);

            }
        };

        $(function() {
            
            Picklr.init();

        });

    </script>

    <!-- BEGIN METADATA EDIT FORM -->
    <form id="tag-editor" action="{{ url_for('save') }}" method="post">
        <input type="hidden" id="fileid" name="fileid" value="0" />
        <input type="hidden" id="page" name="page" value="{{ page }}" />
        <input id="tags" name="tags" type="text" value="" />
        <input id="description" name="description" type="text" value="" />
        <input type="submit" value="Save" /> <input type="button" id="cancel-edit" value="Cancel" />
    </form>
    <!-- END METADATA EDIT FORM -->

    <div id="thumbs" />

    {% raw %}
    <!-- BEGIN CLIENT TEMPLATES -->
    <script id="thumb-template" type="text/x-handlebars-template">
        <div id="i-{{ id }}">
            <a class="edit-tags" href="/file/{{ id }}" data-fileid="{{ id }}" data-tags="{{ tags }}" data-description="{{ description }}">E</a>
            <a class="view-large" href="/file/{{ id }}" data-sharekey="{{ sharekey }}" data-path="{{ path }}"><img src="/static/img/thumbs/{{ id }}.jpg" alt="Added {{ date_added }}" /></a>
        </div>
    </script>
    <script id="status-template" type="text/x-handlebars-template">
        <span>Page: {{ page }}, Pages: {{ total_pages }}, Files: {{ total_files }}</span>
    </script>
    <script id="paging-template" type="text/x-handlebars-template">
        <a href="/{{ n }}" data-page="{{ n }}">{{ n }}</a>
    </script>
    <script id="viewer-template" type="text/x-handlebars-template">
        <div id="large-image-container">
            <div id="large-image">
                <img src="https://dl.dropboxusercontent.com/s/{{ sharekey }}/{{ path }}" /></a>
            </div>
        </div>
    </script>
    <!-- BEGIN CLIENT TEMPLATES -->
    {% endraw %}

{% endblock %}
